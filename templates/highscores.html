{% extends "base.html" %}

{% block content %}
<section class="page-header">
    <h1>RuneScape High Scores</h1>
    <p>Enter a RuneScape username to view their high scores data</p>
</section>

<section class="profile-container">
    <div class="profile-search">
        <form method="POST" action="/highscores">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" placeholder="Enter RuneScape username" 
                       value="{{ username if username else '' }}" required>
                <button type="submit" class="btn">Search</button>
            </div>
        </form>
    </div>

    {% if error %}
    <div class="error-message">
        <p>{{ error }}</p>
    </div>
    {% endif %}

    {% if highscores_data %}
    <div class="highscores-data">
        <div class="highscores-header">
            <h2>{{ username }}'s High Scores</h2>
            <div class="total-stats">
                <p><strong>Total Level:</strong> {{ highscores_data.skills.Total.level }}</p>
                <p><strong>Total XP:</strong> {{ "{:,}".format(highscores_data.skills.Total.xp) }}</p>
                <p><strong>Rank:</strong> {{ "{:,}".format(highscores_data.skills.Total.rank) }}</p>
            </div>
        </div>

        <div class="highscores-content">
            <div class="highscores-section">
                <h3>Skills</h3>
                <div class="skills-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Skill</th>
                                <th>Level</th>
                                <th>XP</th>
                                <th>Rank</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for skill_name, skill_data in highscores_data.skills.items() %}
                            {% if skill_name != 'Total' %}
                            <tr>
                                <td class="skill-name">
                                    <img src="{{ url_for('static', filename='img/21px-' + skill_name + '-icon.webp') }}" alt="{{ skill_name }}">
                                    {{ skill_name }}
                                </td>
                                <td>{{ skill_data.level }}</td>
                                <td>{{ "{:,}".format(skill_data.xp) }}</td>
                                <td>{{ "{:,}".format(skill_data.rank) if skill_data.rank is not none and skill_data.rank > 0 else '-' }}</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="highscores-section">
                <h3>Activities</h3>
                <div class="activities-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Activity</th>
                                <th>Score</th>
                                <th>Rank</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity_name, activity_data in highscores_data.activities.items() %}
                            {% if activity_data.rank is not none and activity_data.rank > 0 %}
                            <tr>
                                <td class="activity-name">
                                    {% if activity_name == "Bounty Hunter" %}
                                    <img src="{{ url_for('static', filename='img/Bounty_Hunter_icon.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Bounty Hunter Rogues" %}
                                    <img src="{{ url_for('static', filename='img/Bounty_Hunter_Rogue_icon.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Dominion Tower" %}
                                    <img src="{{ url_for('static', filename='img/Dominion_tower_highscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "The Crucible" %}
                                    <img src="{{ url_for('static', filename='img/Crucible_icon_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Castle Wars" %}
                                    <img src="{{ url_for('static', filename='img/Castle_Wars_Games_highscores.png') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Barbarian Assault attackers" %}
                                    <img src="{{ url_for('static', filename='img/Barbarian_Assault_Attackers_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Barbarian Assault defenders" %}
                                    <img src="{{ url_for('static', filename='img/Barbarian_Assault_Defenders_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Barbarian Assault collectors" %}
                                    <img src="{{ url_for('static', filename='img/Barbarian_Assault_Collectors_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Barbarian Assault healers" %}
                                    <img src="{{ url_for('static', filename='img/Barbarian_Assault_Healers_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Dual Arena Tournaments" %}
                                    <img src="{{ url_for('static', filename='img/Duel_tournament.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Mobilising Armies" %}
                                    <img src="{{ url_for('static', filename='img/Mobilising_Armies_icon_highscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Conquest" %}
                                    <img src="{{ url_for('static', filename='img/Conquest_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Fist of Guthix" %}
                                    <img src="{{ url_for('static', filename='img/Fist_of_Guthix_icon_highscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "GG: Resource Race" %}
                                    <img src="{{ url_for('static', filename='img/Gielinor_Games_resources_icon_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "GG: Athletics" %}
                                    <img src="{{ url_for('static', filename='img/Gielinor_Games_icon_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "CFP: 5 Game Average" %}
                                    <img src="{{ url_for('static', filename='img/Cabbage_Facepunch_Bonanza_icon_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "RuneScore" %}
                                    <img src="{{ url_for('static', filename='img/RuneScore.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Clue scrolls (easy)" %}
                                    <img src="{{ url_for('static', filename='img/Clue_scrolls_(easy)_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Clue scrolls (medium)" %}
                                    <img src="{{ url_for('static', filename='img/Clue_scrolls_(medium)_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Clue scrolls (hard)" %}
                                    <img src="{{ url_for('static', filename='img/Clue_scrolls_(hard)_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Clue scrolls (elite)" %}
                                    <img src="{{ url_for('static', filename='img/Clue_scrolls_(elite)_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Clue scrolls (master)" %}
                                    <img src="{{ url_for('static', filename='img/Clue_scrolls_(master)_hiscores.webp') }}" alt="{{ activity_name }}">
                                    {% elif activity_name == "Heist Guard Level" or activity_name == "Heist Robber Level" %}
                                    <img src="{{ url_for('static', filename='img/Thieving_icon_highscores.webp') }}" alt="{{ activity_name }}">
                                    {% else %}
                                    <img src="{{ url_for('static', filename='img/21px-Stats_Overall_icon_highscores.webp') }}" alt="{{ activity_name }}">
                                    {% endif %}
                                    {{ activity_name }}
                                </td>
                                <td>{{ "{:,}".format(activity_data.score) }}</td>
                                <td>{{ "{:,}".format(activity_data.rank) }}</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="highscores-visualization">
            <h3>Skills Visualization</h3>
            <div class="chart-container">
                <canvas id="skillsChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</section>

{% if highscores_data %}
<style>
    .activity-name img {
        width: 21px;
        height: 21px;
        vertical-align: middle;
        margin-right: 8px;
    }
    
    .activity-name {
        display: flex;
        align-items: center;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('skillsChart').getContext('2d');
        
        // Extract skill data
        const skillNames = [];
        const skillLevels = [];
        const skillColors = [];
        
        {% for skill_name, skill_data in highscores_data.skills.items() %}
        {% if skill_name != 'Total' %}
        skillNames.push('{{ skill_name }}');
        skillLevels.push({{ skill_data.level }});
        // Generate a random color for each skill
        skillColors.push(`hsl(${Math.floor(Math.random() * 360)}, 70%, 50%)`);
        {% endif %}
        {% endfor %}
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: skillNames,
                datasets: [{
                    label: 'Skill Levels',
                    data: skillLevels,
                    backgroundColor: skillColors,
                    borderColor: skillColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 99
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Level: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endif %}
{% endblock %}
